{% extends "base.html" %}

{% block title %}Nueva Cita{% endblock %}

{% block extra_css %}
<style>
.autocomplete-results {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
}
.autocomplete-results .item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}
.autocomplete-results .item:hover {
    background-color: #f8f9fa;
}
.autocomplete-results .item:last-child {
    border-bottom: none;
}
.autocomplete-results .item .name {
    font-weight: 500;
    color: #333;
}
.autocomplete-results .item .details {
    font-size: 0.875rem;
    color: #666;
}
.col-md-6 {
    position: relative;
}

/* Estilos para calendario semanal */
.calendario-semanal {
    width: 100%;
    border-collapse: collapse;
}
.calendario-semanal th {
    background-color: #f8f9fa;
    padding: 10px;
    text-align: center;
    font-weight: 600;
    border: 1px solid #dee2e6;
}
.calendario-semanal td {
    padding: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
    min-width: 80px;
}
.calendario-semanal .hora-label {
    font-weight: 500;
    background-color: #f8f9fa;
}
.slot {
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}
.slot.disponible {
    background-color: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
}
.slot.disponible:hover {
    background-color: #c3e6cb;
    transform: scale(1.05);
}
.slot.ocupado {
    background-color: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
    cursor: not-allowed;
}
.slot.no-labora {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
}
.slot.vacacion {
    background-color: #fff3cd;
    color: #856404;
    cursor: not-allowed;
}
.slot.permiso {
    background-color: #ffe8a1;
    color: #856404;
    cursor: not-allowed;
}
.slot.seleccionado {
    background-color: #28a745;
    color: white;
    border: 2px solid #1e7e34;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
}
.slot.pasado {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
    text-decoration: line-through;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-calendar-plus"></i> Agendar Nueva Cita</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="formNuevaCita">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="paciente_search" class="form-label">Paciente *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="paciente_search" 
                                   placeholder="Buscar por nombre o c√©dula..." 
                                   autocomplete="off"
                                   required>
                            <input type="hidden" id="paciente_id" name="paciente_id">
                            <div id="paciente_resultados" class="autocomplete-results"></div>
                            <div class="mt-2">
                                <a href="{{ url_for('agendamiento.nuevo_paciente') }}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-person-plus-fill"></i> Registrar Nuevo Paciente
                                </a>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="especialidad_search" class="form-label">Especialidad *</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="especialidad_search" 
                                   placeholder="Buscar especialidad..." 
                                   autocomplete="off"
                                   required>
                            <input type="hidden" id="especialidad_id" name="especialidad_id">
                            <div id="especialidad_resultados" class="autocomplete-results"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="medico_id" class="form-label">M√©dico *</label>
                        <select class="form-select" id="medico_id" name="medico_id" required disabled>
                            <option value="">Primero seleccione una especialidad...</option>
                        </select>
                    </div>
                    
                    <!-- Calendario Semanal -->
                    <div id="calendario_container" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">üìÖ Disponibilidad del M√©dico</h5>
                                    <small class="text-muted" id="periodo_calendario"></small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" id="btn_semana_anterior">
                                        <i class="bi bi-chevron-left"></i> Anterior
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn_semana_actual">
                                        Hoy
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn_semana_siguiente">
                                        Siguiente <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="calendario_semana" class="table-responsive">
                                    <p class="text-center text-muted">Cargando disponibilidad...</p>
                                </div>
                                
                                <!-- Leyenda -->
                                <div class="mt-3 d-flex flex-wrap gap-3">
                                    <span><span class="badge bg-success">‚úì</span> Disponible</span>
                                    <span><span class="badge bg-danger">‚úó</span> Ocupado</span>
                                    <span><span class="badge bg-secondary">-</span> No labora</span>
                                    <span><span class="badge bg-warning">üèñÔ∏è</span> Vacaci√≥n</span>
                                    <span><span class="badge bg-warning">‚ö†Ô∏è</span> Permiso</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cita seleccionada -->
                        <div id="cita_seleccionada" style="display: none;" class="alert alert-info">
                            <h6>‚úì Cita seleccionada:</h6>
                            <p class="mb-0" id="detalle_cita"></p>
                        </div>
                    </div>
                    
                    <!-- Campos ocultos para fecha y hora (siempre en el DOM) -->
                    <input type="hidden" id="fecha" name="fecha">
                    <input type="hidden" id="hora" name="hora">
                    
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo de la Consulta</label>
                        <textarea class="form-control" id="motivo" name="motivo" rows="3"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('agendamiento.listar_citas') }}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Agendar Cita
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== VARIABLES GLOBALES =====
let medicoActual = null;
let fechaActual = new Date();
let slotSeleccionado = null;

// ===== AUTOCOMPLETADO DE PACIENTES =====
const pacienteSearch = document.getElementById('paciente_search');
const pacienteId = document.getElementById('paciente_id');
const pacienteResultados = document.getElementById('paciente_resultados');
let pacienteTimeout;

pacienteSearch.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(pacienteTimeout);
    
    if (query.length < 2) {
        pacienteResultados.style.display = 'none';
        pacienteId.value = '';
        return;
    }
    
    pacienteTimeout = setTimeout(() => {
        fetch(`/agendamiento/api/buscar-pacientes?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    pacienteResultados.innerHTML = '<div class="item"><div class="name">No se encontraron pacientes</div></div>';
                } else {
                    pacienteResultados.innerHTML = data.map(p => `
                        <div class="item" data-id="${p.id}" data-texto="${p.texto}">
                            <div class="name">${p.nombre_completo}</div>
                            <div class="details">CI: ${p.cedula}</div>
                        </div>
                    `).join('');
                }
                pacienteResultados.style.display = 'block';
            });
    }, 300);
});

pacienteResultados.addEventListener('click', function(e) {
    const item = e.target.closest('.item');
    if (item && item.dataset.id) {
        pacienteId.value = item.dataset.id;
        pacienteSearch.value = item.dataset.texto;
        pacienteResultados.style.display = 'none';
    }
});

// ===== AUTOCOMPLETADO DE ESPECIALIDADES =====
const especialidadSearch = document.getElementById('especialidad_search');
const especialidadId = document.getElementById('especialidad_id');
const especialidadResultados = document.getElementById('especialidad_resultados');
let especialidadTimeout;

especialidadSearch.addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(especialidadTimeout);
    
    if (query.length < 2) {
        especialidadResultados.style.display = 'none';
        especialidadId.value = '';
        return;
    }
    
    especialidadTimeout = setTimeout(() => {
        fetch(`/agendamiento/api/buscar-especialidades?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    especialidadResultados.innerHTML = '<div class="item"><div class="name">No se encontraron especialidades</div></div>';
                } else {
                    especialidadResultados.innerHTML = data.map(e => `
                        <div class="item" data-id="${e.id}" data-nombre="${e.nombre}">
                            <div class="name">${e.nombre}</div>
                            ${e.descripcion ? `<div class="details">${e.descripcion}</div>` : ''}
                        </div>
                    `).join('');
                }
                especialidadResultados.style.display = 'block';
            });
    }, 300);
});

especialidadResultados.addEventListener('click', function(e) {
    const item = e.target.closest('.item');
    if (item && item.dataset.id) {
        especialidadId.value = item.dataset.id;
        especialidadSearch.value = item.dataset.nombre;
        especialidadResultados.style.display = 'none';
        cargarMedicos();
    }
});

// Cerrar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('#paciente_search') && !e.target.closest('#paciente_resultados')) {
        pacienteResultados.style.display = 'none';
    }
    if (!e.target.closest('#especialidad_search') && !e.target.closest('#especialidad_resultados')) {
        especialidadResultados.style.display = 'none';
    }
});

// ===== CARGAR M√âDICOS POR ESPECIALIDAD =====
function cargarMedicos() {
    const espId = especialidadId.value;
    const medicoSelect = document.getElementById('medico_id');
    
    if (!espId) {
        medicoSelect.disabled = true;
        medicoSelect.innerHTML = '<option value="">Primero seleccione una especialidad...</option>';
        return;
    }
    
    const fecha = new Date().toISOString().split('T')[0];
    
    fetch(`/agendamiento/api/medicos-por-especialidad/${espId}?fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
            medicoSelect.innerHTML = '<option value="">Seleccionar m√©dico...</option>';
            
            // Agregar m√©dicos disponibles
            if (data.disponibles && data.disponibles.length > 0) {
                const optgroupDisponibles = document.createElement('optgroup');
                optgroupDisponibles.label = 'Disponibles';
                data.disponibles.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = medico.id;
                    option.textContent = medico.nombre;
                    optgroupDisponibles.appendChild(option);
                });
                medicoSelect.appendChild(optgroupDisponibles);
            }
            
            // Agregar m√©dicos no disponibles (deshabilitados con motivo)
            if (data.no_disponibles && data.no_disponibles.length > 0) {
                const optgroupNoDisponibles = document.createElement('optgroup');
                optgroupNoDisponibles.label = 'No disponibles';
                data.no_disponibles.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = '';
                    option.disabled = true;
                    option.textContent = `${medico.nombre} (${medico.motivo_no_disponible})`;
                    optgroupNoDisponibles.appendChild(option);
                });
                medicoSelect.appendChild(optgroupNoDisponibles);
            }
            
            medicoSelect.disabled = false;
        });
}

// ===== CUANDO SELECCIONA M√âDICO =====
document.getElementById('medico_id').addEventListener('change', function() {
    medicoActual = this.value;
    if (medicoActual) {
        document.getElementById('calendario_container').style.display = 'block';
        cargarCalendarioSemanal();
    } else {
        document.getElementById('calendario_container').style.display = 'none';
    }
});

// ===== NAVEGACI√ìN DE SEMANAS =====
document.getElementById('btn_semana_anterior').addEventListener('click', () => {
    fechaActual.setDate(fechaActual.getDate() - 7);
    cargarCalendarioSemanal();
});

document.getElementById('btn_semana_actual').addEventListener('click', () => {
    fechaActual = new Date();
    cargarCalendarioSemanal();
});

document.getElementById('btn_semana_siguiente').addEventListener('click', () => {
    fechaActual.setDate(fechaActual.getDate() + 7);
    cargarCalendarioSemanal();
});

// ===== CARGAR CALENDARIO SEMANAL =====
function cargarCalendarioSemanal() {
    if (!medicoActual) return;
    
    const fecha = fechaActual.toISOString().split('T')[0];
    
    fetch(`/agendamiento/api/disponibilidad-semanal/${medicoActual}?fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
            mostrarCalendario(data);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('calendario_semana').innerHTML = 
                '<p class="text-danger">Error al cargar disponibilidad</p>';
        });
}

// ===== MOSTRAR CALENDARIO =====
function mostrarCalendario(data) {
    const container = document.getElementById('calendario_semana');
    
    // Actualizar per√≠odo en la cabecera
    document.getElementById('periodo_calendario').textContent = data.periodo || '';
    
    // Construir cabecera
    let html = '<table class="calendario-semanal"><thead><tr><th>Hora</th>';
    
    data.calendario.forEach(dia => {
        html += `<th>${dia.dia_semana}</th>`;
    });
    
    html += '</tr></thead><tbody>';
    
    // Obtener todas las horas √∫nicas
    const horasSet = new Set();
    data.calendario.forEach(dia => {
        dia.slots.forEach(slot => horasSet.add(slot.hora));
    });
    const horas = Array.from(horasSet).sort();
    
    // Construir filas por hora
    horas.forEach(hora => {
        html += `<tr><td class="hora-label">${hora}</td>`;
        
        data.calendario.forEach(dia => {
            if (!dia.trabaja) {
                html += '<td><div class="slot no-labora">-</div></td>';
            } else if (dia.en_vacaciones) {
                html += '<td><div class="slot vacacion">üèñÔ∏è</div></td>';
            } else {
                const slot = dia.slots.find(s => s.hora === hora);
                if (slot) {
                    let claseEstado = slot.estado;
                    let texto = '';
                    
                    if (slot.estado === 'disponible') {
                        texto = '‚úì';
                    } else if (slot.estado === 'ocupado') {
                        texto = '‚úó';
                        claseEstado = 'ocupado';
                    } else if (slot.estado === 'permiso') {
                        texto = '‚ö†Ô∏è';
                        claseEstado = 'permiso';
                    } else if (slot.estado === 'pasado') {
                        texto = '-';
                        claseEstado = 'pasado';
                    }
                    
                    html += `<td><div class="slot ${claseEstado}" 
                                     data-fecha="${dia.fecha}" 
                                     data-hora="${hora}" 
                                     onclick="seleccionarSlot(this, '${dia.fecha}', '${hora}', '${slot.estado}')">${texto}</div></td>`;
                } else {
                    html += '<td><div class="slot no-labora">-</div></td>';
                }
            }
        });
        
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ===== SELECCIONAR SLOT =====
function seleccionarSlot(elemento, fecha, hora, estado) {
    console.log('=== SELECCIONANDO SLOT ===');
    console.log('Fecha:', fecha);
    console.log('Hora:', hora);
    console.log('Estado:', estado);
    
    // Verificar que el slot est√© disponible
    if (estado !== 'disponible') {
        if (estado === 'pasado') {
            mostrarMensaje('Fecha no disponible', 'No se pueden agendar citas en fechas u horas pasadas.', 'warning');
        } else if (estado === 'ocupado') {
            mostrarMensaje('Horario ocupado', 'Este horario ya est√° ocupado.', 'warning');
        } else if (estado === 'permiso') {
            mostrarMensaje('Horario no disponible', 'El m√©dico tiene un permiso en este horario.', 'warning');
        }
        return;
    }
    
    // Quitar selecci√≥n anterior
    document.querySelectorAll('.slot.seleccionado').forEach(el => {
        el.classList.remove('seleccionado');
    });
    
    // Marcar como seleccionado
    elemento.classList.add('seleccionado');
    
    // Guardar datos
    const inputFecha = document.getElementById('fecha');
    const inputHora = document.getElementById('hora');
    const divDetalle = document.getElementById('detalle_cita');
    const divSeleccionada = document.getElementById('cita_seleccionada');
    
    console.log('inputFecha:', inputFecha);
    console.log('inputHora:', inputHora);
    console.log('divDetalle:', divDetalle);
    console.log('divSeleccionada:', divSeleccionada);
    
    if (!inputFecha || !inputHora) {
        console.error('CR√çTICO: Campos ocultos no encontrados en el DOM');
        mostrarMensaje('Error', 'Error interno: campos del formulario no encontrados. Recargue la p√°gina con Ctrl+F5', 'error');
        return;
    }
    
    inputFecha.value = fecha;
    inputHora.value = hora;
    
    console.log('Valores asignados - Fecha:', inputFecha.value, 'Hora:', inputHora.value);
    
    // Formatear fecha
    const fechaObj = new Date(fecha + 'T00:00:00');
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = fechaObj.toLocaleDateString('es-ES', opciones);
    
    // Mostrar detalles
    if (divDetalle && divSeleccionada) {
        divDetalle.textContent = `üìÖ ${fechaFormateada} a las ${hora}`;
        divSeleccionada.style.display = 'block';
    }
    
    slotSeleccionado = { fecha, hora };
    console.log('slotSeleccionado guardado:', slotSeleccionado);
}

// Validar formulario antes de enviar
document.getElementById('formNuevaCita').addEventListener('submit', function(e) {
    if (!slotSeleccionado) {
        e.preventDefault();
        mostrarMensaje('Cita incompleta', 'Por favor seleccione una fecha y hora en el calendario', 'warning');
        return false;
    }
});
</script>
{% endblock %}
