{% extends "base.html" %}

{% block title %}Facturar Consulta{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-invoice-dollar"></i> Facturar Consulta</h2>
                <a href="{{ url_for('facturacion.nueva_venta') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Datos del paciente y detalles -->
        <div class="col-lg-7">
            <!-- Datos del Paciente -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> Datos del Paciente</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Nombre:</strong> {{ paciente.nombre_completo }}</p>
                            <p class="mb-2"><strong>Cédula:</strong> {{ paciente.cedula }}</p>
                            <p class="mb-2"><strong>RUC:</strong> 
                                <span id="ruc-display">{{ paciente.ruc or 'Sin RUC' }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Razón Social:</strong> 
                                <span id="razon-display">{{ paciente.razon_social or paciente.nombre_completo }}</span>
                            </p>
                            <p class="mb-2"><strong>Dirección:</strong> 
                                <span id="direccion-display">{{ paciente.direccion_facturacion or paciente.direccion or 'Sin dirección' }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarDatosFactura()">
                            <i class="fas fa-edit"></i> Editar datos de factura
                        </button>
                    </div>
                </div>
            </div>

            <!-- Detalles de la Consulta -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Detalle de la Factura</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-center" width="100">Cantidad</th>
                                    <th class="text-end" width="150">Precio Unit.</th>
                                    <th class="text-end" width="150">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Consulta -->
                                <tr>
                                    <td>
                                        <strong>Consulta - {{ especialidad.nombre }}</strong><br>
                                        <small class="text-muted">Médico: {{ consulta.medico.usuario.nombre_completo }}</small>
                                    </td>
                                    <td class="text-center">1</td>
                                    <td class="text-end">{{ precio_consulta|format_currency }} Gs.</td>
                                    <td class="text-end"><strong>{{ precio_consulta|format_currency }} Gs.</strong></td>
                                </tr>

                                <!-- Procedimientos -->
                                {% if procedimientos %}
                                    {% for proc in procedimientos %}
                                    <tr>
                                        <td>
                                            <strong>{{ proc.procedimiento_rel.nombre }}</strong>
                                            {% if proc.observaciones %}
                                            <br><small class="text-muted">{{ proc.observaciones }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">1</td>
                                        <td class="text-end">{{ proc.precio|format_currency }} Gs.</td>
                                        <td class="text-end"><strong>{{ proc.precio|format_currency }} Gs.</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}

                                <!-- Insumos -->
                                {% if insumos %}
                                    {% for insumo in insumos %}
                                    <tr>
                                        <td>
                                            {{ insumo.insumo_rel.nombre }}
                                            <small class="text-muted">({{ insumo.insumo_rel.unidad_medida }})</small>
                                        </td>
                                        <td class="text-center">{{ insumo.cantidad }}</td>
                                        <td class="text-end">{{ insumo.precio_unitario|format_currency }} Gs.</td>
                                        <td class="text-end"><strong>{{ insumo.subtotal|format_currency }} Gs.</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}

                                <!-- Totales (IVA Incluido - Paraguay) -->
                                <tr class="table-primary">
                                    <td colspan="3" class="text-end"><h5 class="mb-0"><strong>TOTAL:</strong></h5></td>
                                    <td class="text-end"><h5 class="mb-0"><strong>{{ total|format_currency }} Gs.</strong></h5></td>
                                </tr>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end"><small><strong>Gravadas 10%:</strong></small></td>
                                    <td class="text-end"><small><strong>{{ subtotal|format_currency }} Gs.</strong></small></td>
                                </tr>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end"><small><strong>IVA 10%:</strong></small></td>
                                    <td class="text-end"><small><strong>{{ iva|format_currency }} Gs.</strong></small></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Forma de pago -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Registrar Pago</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('facturacion.procesar_factura', consulta_id=consulta.id) }}" id="formPago">
                        <!-- Total a Cobrar -->
                        <div class="alert alert-info text-center">
                            <h4 class="mb-0">Total a Cobrar</h4>
                            <h2 class="mb-0">{{ total|format_currency }} Gs.</h2>
                            <input type="hidden" name="total" value="{{ total }}" id="totalFactura">
                        </div>

                        <!-- Datos de Facturación (ocultos) -->
                        <input type="hidden" name="ruc_factura" id="ruc_factura" value="{{ paciente.ruc or '' }}">
                        <input type="hidden" name="nombre_factura" id="nombre_factura" value="{{ paciente.razon_social or paciente.nombre_completo }}">
                        <input type="hidden" name="direccion_factura" id="direccion_factura" value="{{ paciente.direccion_facturacion or paciente.direccion or '' }}">

                        <!-- Pagos: ahora soportamos múltiples formas de pago mediante modal y grilla -->
                        <input type="hidden" name="pagos_json" id="pagos_json" value="">

                        <!-- Hidden fallback fields (kept for backward compatibility) -->
                        <input type="hidden" name="monto_efectivo" id="monto_efectivo" value="0">
                        <input type="hidden" name="monto_debito" id="monto_debito" value="0">
                        <input type="hidden" name="monto_credito" id="monto_credito" value="0">

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="abrirModalPago()">
                                <i class="fas fa-plus-circle"></i> Agregar Forma de Pago
                            </button>
                        </div>

                        <!-- Grilla de pagos añadidos -->
                        <div class="mb-3">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="tablaPagos">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Forma</th>
                                            <th class="text-end" width="150">Monto (Gs.)</th>
                                            <th class="text-center" width="80">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- filas dinámicas -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Total Recibido -->
                        <div class="alert alert-secondary">
                            <div class="d-flex justify-content-between">
                                <strong>Total Recibido:</strong>
                                <span id="totalRecibido">0 Gs.</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <strong>Diferencia:</strong>
                                <span id="diferencia" class="text-danger">-{{ total|format_currency }} Gs.</span>
                            </div>
                        </div>

                        <!-- Vuelto -->
                        <div id="vueltoDiv" class="alert alert-success" style="display: none;">
                            <div class="text-center">
                                <h5 class="mb-1">Vuelto</h5>
                                <h3 class="mb-0" id="vuelto">0 Gs.</h3>
                            </div>
                        </div>

                                        <!-- Nota sobre vuelto / efectivo insuficiente -->
                                        <div id="vuelto_note_container" style="display:none;" class="mt-2">
                                            <p id="vuelto_note" class="small text-warning mb-0"></p>
                                        </div>

                        <!-- Resumen de cobro: TOTAL y Restante -->
                        <div class="mb-3">
                            <label class="form-label"><strong>TOTAL:</strong></label>
                            <div class="h4">{{ total|format_currency }} Gs.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Restante por cobrar:</strong></label>
                            <div class="h5 text-danger" id="restanteCobrar">{{ total|format_currency }} Gs.</div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="btnConfirmar" disabled>
                                <i class="fas fa-check-circle"></i> Confirmar Factura
                            </button>
                            <a href="{{ url_for('facturacion.nueva_venta') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar forma de pago -->
<div class="modal fade" id="modalAgregarPago" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Forma de Pago</label>
                    <select id="select_forma" class="form-select">
                        {% for fp in formas_pago %}
                        <option value="{{ fp.id }}">{{ fp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Monto (Gs.)</label>
                    <!-- Usamos un manejador específico para este input para evitar interferencias con el formateador global -->
                    <input type="text" class="form-control" id="input_monto" value="">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarPago()">Agregar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar datos de factura -->
<div class="modal fade" id="modalEditarDatos" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Datos de Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">RUC</label>
                    <input type="text" class="form-control" id="edit_ruc" 
                           value="{{ paciente.ruc or '' }}" maxlength="20">
                </div>
                <div class="mb-3">
                    <label class="form-label">Razón Social</label>
                    <input type="text" class="form-control" id="edit_razon" 
                           value="{{ paciente.razon_social or paciente.nombre_completo }}" maxlength="200">
                </div>
                <div class="mb-3">
                    <label class="form-label">Dirección de Facturación</label>
                    <textarea class="form-control" id="edit_direccion" rows="2">{{ paciente.direccion_facturacion or paciente.direccion or '' }}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarDatosFactura()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal final que muestra el vuelto -->
<div class="modal fade" id="modalVuelto" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h5 class="mb-2">Vuelto</h5>
                <p id="modalVueltoText" class="h4 mb-0">0 Gs.</p>
                <small class="text-muted">Presione cualquier tecla para continuar</small>
            </div>
        </div>
    </div>
</div>

<script>
    const totalFactura = parseFloat('{{ total }}');

    // Pagos array almacenará objetos: { forma_pago_id, forma_nombre (opcional), monto, referencia }
    let pagos = [];

    function abrirModalPago() {
        // reset modal inputs
        document.getElementById('input_monto').value = '0';
        // seleccionar el input y dejar listo para editar
        setTimeout(() => {
            const inp = document.getElementById('input_monto');
            try { inp.focus(); inp.select(); } catch(e){}
        }, 50);
        new bootstrap.Modal(document.getElementById('modalAgregarPago')).show();
    }

    // Asegurar que si el usuario hace foco manual en el campo monto y su valor es 0,
    // el campo se seleccione para facilitar sobreescribirlo.
    document.addEventListener('DOMContentLoaded', function() {
        const inputMonto = document.getElementById('input_monto');
        if (inputMonto) {
            inputMonto.addEventListener('focus', function() {
                const plain = parseFormattedNumberToPlain(this.value) || '';
                if (plain === '' || plain === '0' || plain === '0.0') {
                    try { this.select(); } catch(e) {}
                }
            });
            // Formateo en vivo específico para este campo: mantener separador de miles
            const formatMontoLive = function() {
                let raw = this.value || '';
                // quitar todo lo que no sea dígito
                const digits = raw.replace(/[^0-9]/g, '');
                if (digits === '') { this.value = ''; return; }
                // parsear como entero
                const n = parseInt(digits, 10) || 0;
                // formatear con puntos de miles
                const formatted = formatNumberWithDots(String(n));
                // asignar y mover caret al final
                this.value = formatted;
                try { this.setSelectionRange(this.value.length, this.value.length); } catch(e){}
            };

            inputMonto.addEventListener('input', formatMontoLive);
        }
    });

    function agregarPago() {
        const formaId = document.getElementById('select_forma').value;
        const formaNombre = document.getElementById('select_forma').options[document.getElementById('select_forma').selectedIndex].text;
        const montoRaw = document.getElementById('input_monto').value || '0';
        // parseo robusto: quitar todo lo que no sea dígito, coma o punto; convertir miles (.) y coma decimal
        function parseMoneyString(str) {
            if (str === null || str === undefined) return 0;
            let s = String(str).trim();
            if (s === '') return 0;
            // eliminar espacios
            s = s.replace(/\s+/g, '');
            // si tiene coma decimal (ej '1.234,56'), eliminar puntos y reemplazar coma por punto
            if ((s.match(/,/g) || []).length === 1 && (s.match(/\./g) || []).length >= 1) {
                s = s.replace(/\./g, '').replace(',', '.');
            } else {
                // eliminar puntos (miles) y reemplazar coma por punto
                s = s.replace(/\./g, '').replace(',', '.');
            }
            const n = Number(s);
            return isNaN(n) ? 0 : n;
        }
        const monto = parseMoneyString(montoRaw) || 0;

        // Debug: mostrar en consola el valor crudo y parseado y existencia de elementos clave
        try {
            console.log('agregarPago:', { montoRaw: montoRaw, monto: monto, totalRecibidoEl: !!document.getElementById('totalRecibido'), diferenciaEl: !!document.getElementById('diferencia'), restanteEl: !!document.getElementById('restanteCobrar') });
        } catch (e) { console.log('agregarPago: debug failed', e); }
        if (monto <= 0) {
            alert('Ingrese un monto mayor a 0');
            return;
        }

    pagos.push({ forma_pago_id: formaId, forma_nombre: formaNombre, monto: monto });
        renderPagos();
        updateTotals();
        bootstrap.Modal.getInstance(document.getElementById('modalAgregarPago')).hide();
    }

    function quitarPago(index) {
        pagos.splice(index, 1);
        renderPagos();
        updateTotals();
    }

    function renderPagos() {
        const tbody = document.querySelector('#tablaPagos tbody');
        tbody.innerHTML = '';
        pagos.forEach((p, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.forma_nombre || p.forma_pago_id}</td>
                <td class="text-end">${formatNumberWithDots(p.monto)}</td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger" onclick="quitarPago(${idx})">Quitar</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateTotals() {
        const totalRecibido = pagos.reduce((s, p) => s + (parseFloat(p.monto) || 0), 0);
        const diferencia = totalRecibido - totalFactura;

        // asegurarse de que existan elementos donde mostrar totales; si no, crear placeholders ocultos
        let totalRecEl = document.getElementById('totalRecibido');
        let diffEl = document.getElementById('diferencia');
        const formPago = document.getElementById('formPago');
        if (!totalRecEl && formPago) {
            totalRecEl = document.createElement('span');
            totalRecEl.id = 'totalRecibido';
            totalRecEl.style.display = 'none';
            formPago.appendChild(totalRecEl);
        }
        if (!diffEl && formPago) {
            diffEl = document.createElement('span');
            diffEl.id = 'diferencia';
            diffEl.style.display = 'none';
            formPago.appendChild(diffEl);
        }

        if (totalRecEl) totalRecEl.textContent = formatNumber(totalRecibido) + ' Gs.';
        if (diffEl) diffEl.textContent = formatNumber(diferencia) + ' Gs.';

        // Mostrar restante por cobrar (total - recibido)
        const restante = totalFactura - totalRecibido;
        const restanteEl = document.getElementById('restanteCobrar');
        if (restanteEl) {
            if (restante <= 0) {
                restanteEl.className = 'h5 text-success';
                restanteEl.textContent = '0 Gs.';
            } else {
                restanteEl.className = 'h5 text-danger';
                restanteEl.textContent = formatNumber(restante) + ' Gs.';
            }
        } else {
            console.warn('updateTotals: elemento #restanteCobrar no encontrado');
        }

        // Ajustar color de la diferencia si el elemento existe
        if (diffEl) {
            if (diferencia < 0) {
                diffEl.className = 'text-danger';
            } else if (Math.abs(diferencia) < 0.001) {
                diffEl.className = 'text-success';
            } else {
                diffEl.className = 'text-info';
            }
        }

        // Vuelto: mostrar cuando la suma de pagos excede el total
        const vueltoDiv = document.getElementById('vueltoDiv');
        const vueltoEl = document.getElementById('vuelto');
        const vueltoNoteContainer = document.getElementById('vuelto_note_container');
        const vueltoNote = document.getElementById('vuelto_note');

        // calcular efectivo disponible (suma de pagos cuya forma contiene 'efectivo')
        const efectivoSum = pagos.reduce((s, p) => {
            const name = (p.forma_nombre || '').toLowerCase();
            if (name.includes('efectivo')) return s + (parseFloat(p.monto) || 0);
            return s;
        }, 0);

        const vuelto = Math.max(0, diferencia);
        if (vueltoDiv) {
            if (vuelto > 0) {
                const vueltoRounded = Math.round(vuelto);
                if (vueltoEl) vueltoEl.textContent = formatNumberWithDots(String(vueltoRounded)) + ' Gs.';
                vueltoDiv.style.display = 'block';

                // Nota: indicar si no hay efectivo suficiente para devolver el vuelto
                if (vueltoNoteContainer && vueltoNote) {
                    if (efectivoSum < vueltoRounded) {
                        const falta = Math.round(vueltoRounded - efectivoSum);
                        vueltoNote.textContent = `No hay suficiente efectivo para devolver el vuelto. Falta: ${formatNumberWithDots(String(falta))} Gs. (Efectivo disponible: ${formatNumberWithDots(String(Math.round(efectivoSum))) } Gs.)`;
                        vueltoNoteContainer.style.display = 'block';
                    } else {
                        // todo: podríamos mostrar 'Vuelto cubierto en efectivo' o esconder la nota
                        vueltoNoteContainer.style.display = 'none';
                    }
                }
            } else {
                vueltoDiv.style.display = 'none';
                if (vueltoNoteContainer) vueltoNoteContainer.style.display = 'none';
            }
        }

        const btnConfirm = document.getElementById('btnConfirmar');
        if (btnConfirm) btnConfirm.disabled = totalRecibido < totalFactura;
    }

    function formatNumber(num) {
        return Math.round(num).toLocaleString('es-PY');
    }

    function editarDatosFactura() {
        new bootstrap.Modal(document.getElementById('modalEditarDatos')).show();
    }

    function guardarDatosFactura() {
        const ruc = document.getElementById('edit_ruc').value;
        const razon = document.getElementById('edit_razon').value;
        const direccion = document.getElementById('edit_direccion').value;
        
        // Actualizar campos ocultos del formulario
        document.getElementById('ruc_factura').value = ruc;
        document.getElementById('nombre_factura').value = razon;
        document.getElementById('direccion_factura').value = direccion;
        
        // Actualizar displays
        document.getElementById('ruc-display').textContent = ruc || 'Sin RUC';
        document.getElementById('razon-display').textContent = razon;
        document.getElementById('direccion-display').textContent = direccion || 'Sin dirección';
        
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalEditarDatos')).hide();
    }

    // Inicializar cálculo
    renderPagos();
    updateTotals();

    // Antes de enviar el formulario, serializar los pagos a pagos_json y limpiar campos fallback
    document.getElementById('formPago').addEventListener('submit', async function (e) {
        e.preventDefault();
        // Serializar pagos
        document.getElementById('pagos_json').value = JSON.stringify(pagos);

        // Reset hidden fallback monto fields to 0 to avoid double counting on server
        document.getElementById('monto_efectivo').value = 0;
        document.getElementById('monto_debito').value = 0;
        document.getElementById('monto_credito').value = 0;

        const form = this;
        const btn = document.getElementById('btnConfirmar');
        if (btn) btn.disabled = true;

        // preparar FormData
        const formData = new FormData(form);

        try {
            const resp = await fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            if (!resp.ok) {
                // Si hubo error, reactivar el botón y mostrar mensaje con más detalle en consola
                if (btn) btn.disabled = false;
                let bodyText = '';
                try {
                    bodyText = await resp.text();
                } catch (e) {
                    console.warn('No se pudo leer el cuerpo de la respuesta de error', e);
                }
                console.error('Error al procesar factura. status=', resp.status, 'body=', bodyText);
                const userMsg = resp.status >= 500 ? 'Error del servidor. Revise los logs del servidor.' : 'Ocurrió un error al procesar la factura. Intente nuevamente.';
                mostrarMensaje('Error', userMsg, 'error');
                return;
            }

            // Al llegar aquí, asumimos que el servidor procesó la factura correctamente.
            const respJson = await resp.json();
            const ventaId = respJson.venta_id;
            
            console.log('[FACTURA] Factura procesada exitosamente. Venta ID:', ventaId);
            
            // Descargar ticket automáticamente usando iframe oculto
            console.log('[FACTURA] Iniciando descarga automática del ticket...');
            const ticketUrl = `/facturacion/ventas/${ventaId}/ticket`;
            const downloadFrame = document.createElement('iframe');
            downloadFrame.style.display = 'none';
            downloadFrame.src = ticketUrl;
            document.body.appendChild(downloadFrame);
            console.log('[FACTURA] Ticket descargándose desde:', ticketUrl);
            
            // Mostrar modal con el vuelto calculado en cliente
            const totalRecibido = pagos.reduce((s, p) => s + (parseFloat(p.monto) || 0), 0);
            const vuelto = Math.max(0, Math.round(totalRecibido - totalFactura));

            // Rellenar modal y mostrar
            const modalVueltoEl = document.getElementById('modalVueltoText');
            if (modalVueltoEl) modalVueltoEl.textContent = formatNumberWithDots(String(vuelto)) + ' Gs.';

            // Mostrar modal de vuelto con comprobaciones: asegurar que el elemento exista y que Bootstrap esté cargado
            const modalContainer = document.getElementById('modalVuelto');
            let modalInstance = null;
            if (modalContainer) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        modalInstance = new bootstrap.Modal(modalContainer);
                        modalInstance.show();
                    } catch (e) {
                        console.error('Error inicializando Modal de Bootstrap:', e);
                        // Fallback: hacer visible el modal sin inicializar la funcionalidad de Bootstrap
                        modalContainer.style.display = 'block';
                    }
                } else {
                    console.warn('Bootstrap no está disponible (window.bootstrap undefined). Mostrando modal simple.');
                    modalContainer.style.display = 'block';
                }
            } else {
                console.warn('Elemento #modalVuelto no encontrado en DOM.');
            }

            // Cuando la cajera presione cualquier tecla, ocultar modal (si está) y redirigir a ventas pendientes
            const onKey = function () {
                try {
                    if (modalInstance && typeof modalInstance.hide === 'function') modalInstance.hide();
                    else if (modalContainer) modalContainer.style.display = 'none';
                } catch (e) {
                    console.warn('Error cerrando modal de vuelto:', e);
                }
                document.removeEventListener('keydown', onKey);
                window.location.href = "{{ url_for('facturacion.ventas_pendientes') }}";
            };

            document.addEventListener('keydown', onKey);

        } catch (err) {
            if (btn) btn.disabled = false;
            mostrarMensaje('Error', 'No se pudo conectar con el servidor. Compruebe su conexión.', 'error');
            console.error(err);
        }
    });
</script>
{% endblock %}
